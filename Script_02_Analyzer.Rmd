---
title: "Data analysis for WP6"
author: "Patrizia Maier"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---


```{r setup, include=F, cache=F}

library(tidyverse)
library(gtsummary)
library(rstatix)
#library(janitor)
library(kableExtra)
# install.packages('tinytex')
# tinytex::install_tinytex() # latex for pdf file creation

```


```{r load_data, include=F}
in_file <- "WP6_data/WP6_individual_data.Rdata"
load(in_file)
rm(in_file)

data_individual <- data_individual %>% 
  mutate(groupNo=factor(groupNo, levels=c(1,0), labels=c("ALS", "Ctrl")))

in_file <- "WP6_data/WP6_starmate_probe_data.Rdata"
load(in_file)
rm(in_file)

data_sm_suc <- data_sm %>% 
  filter(success==1)
```


# Sample demographics
Cross-sectional comparison between

* ALS (n = `r length(unique(data_individual$id[data_individual$groupNo=="1"]))`) 
* Control (n = `r length(unique(data_individual$id[data_individual$groupNo=="0"]))`)


```{r demo_all, echo=F, message=F, warning=F}

t1 <- data_individual %>% 
  select(groupNo, sex, ageYears, educationYears, languageGerman, SantaBarbaraSenseOfDirectionScale) %>%  
  tbl_summary(by=groupNo, 
              label=list(sex ~ "Sex", ageYears ~ "Age", educationYears ~ "Years total education",
                         languageGerman ~ "German native speaker", 
                         SantaBarbaraSenseOfDirectionScale ~ "Self-rated spatial abilities (SBSDS)"),
              statistic=list(all_continuous() ~ "{median} (IQR: {p25}-{p75})",
                             all_categorical() ~ "{n} ({p}%)"),
              digits=list(all_continuous() ~ c(1, 2, 1, 1)),
              missing="no") %>% 
  add_p(test=list(all_continuous() ~ "wilcox.test", all_categorical() ~  "chisq.test")) %>% 
  modify_header(label = "**Variable**")

t1 %>% as_flex_table()

# t1 %>%
#   as_flex_table() %>%
#   flextable::save_as_docx(path="WP6_data/ALS_CTRL_Demographics.docx")

```

```{r demo_clinical, echo=F, message=F, warning=F}

t2 <- data_individual %>% 
  filter(groupNo=="ALS") %>% 
  select(MN_involvement, ALS_variant, `ALSFRS-R`, `ALSFRS-R progression/month`, months_symptoms, months_diagnosis) %>% 
  tbl_summary(label=list(MN_involvement ~ "MN involvement", 
                         ALS_variant ~ "ALS (bulbar/spinal)", 
                         months_symptoms ~ "Months since inital symptoms",
                         months_diagnosis ~ "Months since diagnosis"),
              statistic=list(all_continuous() ~ "{median} (IQR: {p25}-{p75})",
                             all_categorical() ~ "{n} ({p}%)"),
              digits=list(all_continuous() ~ c(1, 1))) %>% 
  add_n() %>%
  modify_header(label = "**Variable**")

t2 %>% as_flex_table()

# t2 %>%
#   as_flex_table() %>%
#   flextable::save_as_docx(path="WP6_data/ALS_Clinical.docx")

```

# Results 

## Post-navigational scoring 

```{r results_scoring, echo=F, message=F, warning=F}

effect_size <- function(data, variable, by, ...) {
  rstatix::wilcox_effsize(data, as.formula(glue::glue("{variable} ~ {by}")))$effsize
}

t3 <- data_individual %>% 
  select(groupNo, POST_mazeReconstruction, POST_objectIdentity, POST_objectLocation) %>% 
  tbl_summary(by=groupNo,
              type=list(everything() ~ 'continuous'),
              label=list(POST_objectIdentity ~ "Object identity", 
                         POST_objectLocation ~ "Object location", 
                         POST_mazeReconstruction ~ "Maze reconstruction"),
              statistic=list(all_continuous() ~ "{median} ({p25}-{p75})"),
              digits=list(all_continuous() ~ c(2, 2)),
              missing="no") %>% 
  add_stat(fns=everything() ~ effect_size) %>%
  add_p(test=list(everything() ~ "wilcox.test"), 
        pvalue_fun=function(x) style_number(x, digits=3)) %>%  
  modify_header(list(label="**Post-navigation memory**", add_stat_1="**effect size**"))

t3 %>% as_flex_table()

# t3 %>%
#   as_flex_table() %>%
#   flextable::save_as_docx(path="WP6_data/ALS_CTRL_Scoring.docx")

```

## Neuropsychological data 

```{r results_np, echo=F, message=F, warning=F}

effect_size <- function(data, variable, by, ...) {
  rstatix::wilcox_effsize(data, as.formula(glue::glue("{variable} ~ {by}")))$effsize
}

t4 <- data_individual %>% 
  select(groupNo, ECAS_executive, ECAS_verbalFluency, ECAS_language, ECAS_verbalMemory, ECAS_visuospatial, 
         SPART_immediateMemory, SPART_delayedMemory, SPART_overallMemory, 
         `5PT`, PTSOT) %>% 
  tbl_summary(by=groupNo,
              type=list(everything() ~ 'continuous'),
              label=list(ECAS_executive ~ "ECAS executive",
                         ECAS_verbalFluency ~ "ECAS fluency",
                         ECAS_language ~ "ECAS language",
                         ECAS_verbalMemory ~ "ECAS memory", 
                         ECAS_visuospatial ~ "ECAS visuospatial", 
                         SPART_immediateMemory ~ "SPART immediate",
                         SPART_delayedMemory ~ "SPART delayed",
                         SPART_overallMemory ~ "SPART total memory",
                         `5PT` ~ "5PT fluency",
                         PTSOT ~ "PTSOT orientation"),
              statistic=list(everything() ~ "{median} ({p25}-{p75})"),
              digits=list(everything() ~ c(2, 2)),
              missing="no") %>% 
  add_stat(fns=everything() ~ effect_size) %>%
  add_p(test=list(everything() ~ "wilcox.test"), 
        pvalue_fun=function(x) style_number(x, digits=3)) %>% 
  modify_header(list(label="**Neuropsychology**", add_stat_1="**effect size**"))

t4 %>% as_flex_table()

# t4 %>%
#   as_flex_table() %>%
#   flextable::save_as_docx(path="WP6_data/ALS_CTRL_Neuropsychology.docx")

```

```{r results_np_impairment, echo=F, message=F, warning=F}

temp <- data_individual %>% 
  select(id, groupNo, ends_with("below_cut"))

t5 <- temp %>% 
  select(-id) %>% 
  tbl_summary(by=groupNo) %>% 
  add_n()

t5 %>% as_flex_table()

temp <- temp %>% 
  drop_na()

```

Participants below executive cut-off: `r temp$id[temp$ECAS_sub_executive_below_cut]`

Participants below fluency cut-off: `r temp$id[temp$ECAS_sub_verbal_fluency_below_cut]`

Participants below language cut-off: `r temp$id[temp$ECAS_sub_language_below_cut]`

Participants below memory cut-off: `r temp$id[temp$ECAS_sub_memory_below_cut]`

Participants below visuospatial cut-off: `r temp$id[temp$ECAS_sub_spatial_below_cut]`


## Correlations

```{r results_correlation, echo=F, message=F, warning=F}

temp <- data_individual  %>% select(id, groupNo, ECAS_total_score, ECAS_sub_memory, 
                                    dfb_q1_sex, dfb_q2_age, dfb_q3_years_edu_total,
                                    `ALS-FRS-R`, `FRS-/Monat`, is_t1_months, id_t1_months) %>%
  drop_na(ECAS_sub_memory) %>% filter(groupNo=="ALS")

ggplot(temp, aes(x=`ALS-FRS-R`, y=ECAS_total_score)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_total_score, temp$`ALS-FRS-R`, method="spearman")

ggplot(temp, aes(x=`FRS-/Monat`, y=ECAS_total_score)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_total_score, temp$`FRS-/Monat`, method="spearman")

ggplot(temp, aes(x=`ALS-FRS-R`, y=ECAS_sub_memory)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_sub_memory, temp$`ALS-FRS-R`, method="spearman")

ggplot(temp, aes(x=`FRS-/Monat`, y=ECAS_sub_memory)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_sub_memory, temp$`FRS-/Monat`, method="spearman")

ggplot(temp, aes(x=is_t1_months, y=ECAS_sub_memory)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_sub_memory, temp$is_t1_months, method="spearman")

ggplot(temp, aes(x=id_t1_months, y=ECAS_sub_memory)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_sub_memory, temp$id_t1_months, method="spearman")

ggplot(temp, aes(x=dfb_q2_age, y=ECAS_sub_memory)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_sub_memory, temp$dfb_q2_age, method="spearman")

ggplot(temp, aes(x=dfb_q3_years_edu_total, y=ECAS_sub_memory)) + geom_smooth(method="lm") + geom_point()
cor.test(temp$ECAS_sub_memory, temp$dfb_q3_years_edu_total, method="spearman")

m0 <- glm(ECAS_sub_memory ~ dfb_q1_sex + dfb_q2_age + dfb_q3_years_edu_total + 
            `ALS-FRS-R` + `FRS-/Monat` + is_t1_months, data=temp) 
summary(m0)
performance::r2(m0)

rm(m0)
```

# Supplement subgroup analysis with starmaze data 

```{r results_supplement_MN, echo=F, message=F, warning=F}

# ALS, PLS vs. PMA 
# all probe trials 
model.mn <- data_sm %>% 
  filter(groupNo=="ALS") %>% 
  group_by(id, trialCondition, MN_involvement) %>% 
  summarize_at(vars(success), mean, na.rm=T) %>% 
  ungroup()

model.mn %>% 
    group_by(trialCondition, MN_involvement) %>% 
    summarize_at(vars(success), mean, na.rm=T)

# success 
model.mn %>% filter(trialCondition=="base") %>% 
  kruskal_test(success ~ MN_involvement)
model.mn %>% filter(trialCondition=="ego") %>% 
  kruskal_test(success ~ MN_involvement)
model.mn %>% filter(trialCondition=="allo") %>% 
  kruskal_test(success ~ MN_involvement)

rm(model.mn)


# successful probe trials 
model.mn_suc <- data_sm_suc %>% 
  filter(groupNo=="ALS") %>% 
  group_by(id, trialCondition, MN_involvement) %>% 
  summarize_at(vars(latency_seconds, pathError_percent, searchAccuracy_percent), mean, na.rm=T) %>% 
  ungroup()

model.mn_suc %>% 
    group_by(trialCondition, MN_involvement) %>% 
    summarize_at(vars(latency_seconds, pathError_percent, searchAccuracy_percent), mean, na.rm=T)

# latency 
model.mn_suc %>% filter(trialCondition=="base") %>% 
  kruskal_test(latency_seconds ~ MN_involvement)
model.mn_suc %>% filter(trialCondition=="base") %>% 
  pairwise_wilcox_test(latency_seconds ~ MN_involvement, adjust="bonferroni") # trend p=0.08 PMA > ALS in baseline 
model.mn_suc %>% filter(trialCondition=="ego") %>% 
  kruskal_test(latency_seconds ~ MN_involvement)
model.mn_suc %>% filter(trialCondition=="allo") %>% 
  kruskal_test(latency_seconds ~ MN_involvement)

# path 
model.mn_suc %>% filter(trialCondition=="base") %>% 
  kruskal_test(pathError_percent ~ MN_involvement)
model.mn_suc %>% filter(trialCondition=="ego") %>% 
  kruskal_test(pathError_percent ~ MN_involvement)
model.mn_suc %>% filter(trialCondition=="allo") %>% 
  kruskal_test(pathError_percent ~ MN_involvement)

# search  
model.mn_suc %>% filter(trialCondition=="base") %>% 
  kruskal_test(searchAccuracy_percent ~ MN_involvement)
model.mn_suc %>% filter(trialCondition=="ego") %>% 
  kruskal_test(searchAccuracy_percent ~ MN_involvement)
model.mn_suc %>% filter(trialCondition=="allo") %>% 
  kruskal_test(searchAccuracy_percent ~ MN_involvement)

rm(model.mn_suc)
```

```{r results_supplement_ALSci, echo=F, message=F, warning=F}

# ALSci vs. ALS normal 
# all probe trials 
model.ci <- data_sm %>% 
  filter(groupNo=="ALS") %>% 
  group_by(id, trialCondition, ALSci) %>% 
  summarize_at(vars(success), mean, na.rm=T) %>% 
  ungroup()

model.ci %>% 
    group_by(trialCondition, ALSci) %>% 
    summarize_at(vars(success), mean, na.rm=T)

# success
model.ci %>% filter(trialCondition=="base") %>% 
  wilcox_test(success ~ ALSci)
model.ci %>% filter(trialCondition=="ego") %>% 
  wilcox_test(success ~ ALSci)
model.ci %>% filter(trialCondition=="allo") %>% 
  wilcox_test(success ~ ALSci)

rm(model.ci)


# successful probe trials 
model.ci_suc <- data_sm_suc %>% 
  filter(groupNo=="ALS") %>% 
  group_by(id, trialCondition, ALSci) %>% 
  summarize_at(vars(latency_seconds, pathError_percent, searchAccuracy_percent), mean, na.rm=T) %>% 
  ungroup()

model.ci_suc %>% 
    group_by(trialCondition, ALSci) %>% 
    summarize_at(vars(latency_seconds, pathError_percent, searchAccuracy_percent), mean, na.rm=T)

# latency
model.ci_suc %>% filter(trialCondition=="base") %>% 
  wilcox_test(latency_seconds ~ ALSci)
model.ci_suc %>% filter(trialCondition=="ego") %>% 
  wilcox_test(latency_seconds ~ ALSci)
model.ci_suc %>% filter(trialCondition=="allo") %>% 
  wilcox_test(latency_seconds ~ ALSci)

# path
model.ci_suc %>% filter(trialCondition=="base") %>% 
  wilcox_test(pathError_percent ~ ALSci)
model.ci_suc %>% filter(trialCondition=="ego") %>% 
  wilcox_test(pathError_percent ~ ALSci)
model.ci_suc %>% filter(trialCondition=="allo") %>% 
  wilcox_test(pathError_percent ~ ALSci)

# search
model.ci_suc %>% filter(trialCondition=="base") %>% 
  wilcox_test(searchAccuracy_percent ~ ALSci)
model.ci_suc %>% filter(trialCondition=="ego") %>% 
  wilcox_test(searchAccuracy_percent ~ ALSci)
model.ci_suc %>% filter(trialCondition=="allo") %>% 
  wilcox_test(searchAccuracy_percent ~ ALSci)

rm(model.ci_suc)
```

# Recruting 

```{r recruiting, echo=F, message=F, warning=F}

read_sheets <- function(filename, tibble = FALSE) {
  sheets <- readxl::excel_sheets(filename)
  x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X, skip=2))
  if(!tibble) x <- lapply(x, as.data.frame)
  names(x) <- sheets
  x
}

filename1 <- "WP6_data/Rekrutierung_210820.xlsx"
mysheets <- read_sheets(filename1)
names_invite <- do.call(rbind.data.frame, mysheets) %>% 
  select(-c(Alter, Adresse, `Termin Tag`, `Termin Uhrzeit`, RÃ¼ckmeldung, Notizen)) %>% 
  filter(`Brief verschickt` != "nein") %>% 
  select(-c(`Brief verschickt`)) %>% 
  unique() %>% 
  unite(Vorname, Nachname, col="Name", sep=" ") %>% 
  arrange(Name) 

filename2 <- "WP6_data/WP6_id_List_6200_6399.xlsx"
names_participate <- readxl::read_excel(filename2, skip=1, n_max=52, trim_ws = T) %>% 
  select(Name) %>% 
  arrange(Name)

rm(filename1, filename2, read_sheets)
```

## People that were recruited via mail (with help of ALS-Ambulanz)
N of letters = `r length(names_invite$Name) `

N of respondents = `r length(names_invite$Name[names_invite$Name %in% names_participate$Name]) `
(`r round(length(names_invite$Name[names_invite$Name %in% names_participate$Name])/length(names_invite$Name)*100, digits=2)`)

## People that were recruited elsewhere (e.g. from the Neurology ward)
N of respondents = `r length(names_participate$Name[!names_participate$Name %in% names_invite$Name]) `
